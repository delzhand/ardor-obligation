<html>
<head>
<title>Combat Engine</title>
<style>
    html {
      background: black;
    }
  
    .wrapper {
      width: 700px;
    }
  
    section {
      background: radial-gradient(-180px 0px,circle ,#0053ad 300px,#001b85 500px,#000223);
      background: -moz-radial-gradient(-180px 0px,circle ,#0053ad 300px,#001b85 500px,#000223);
      background: -webkit-radial-gradient(-180px 0px,circle ,#0053ad 300px,#001b85 500px,#000223);
      background: -o-radial-gradient(-180px 0px,circle ,#0053ad 300px,#001b85 500px,#000223);
      border: 5px solid #FFF;
      -moz-border-radius: 15px;
      -webkit-border-radius: 15px;
      border-radius: 15px;
      box-sizing: border-box;
      -moz-box-sizing: border-box;
      -webkit-box-sizing: border-box;
      padding: 10px;
      font: 16px arial;
      color: white;
      position: relative;
    }

    #log {
      margin-top: -.5em;
    }

    .round {
      font-size: 1.25em;
      margin-top: .5em;
    }

    .turn {
      font-weight: bold;
      margin-top: .5em;
    }

    .err {
      color: gray;
    }

    .defeat,
    .victory {
      font-size: 1.5em;
    }
</style>
</head>
<body>
  <section>
    <div id="log"></div>
  </section>
  <script>
    // Enemy Stats
    let enemyHP = 5;
    let enemyAtk = 5;
    let enemies = ['Obela'];

    // Party Stats
    let partyLvs = [7, 7, 6, 3];
    let partyHps = [150, 150, 150, 150];
    let partyMaxHps = [150, 150, 150, 150];
    let partyMembers = ['Alexei', 'Tia', 'Hilda', 'Stafford'];

    // Input
    let playerTurns = [
      {p: "see317", a: ['move', 'attack', 'defend']},
      {p: "zekebeau", a: ['move', 'defend', 'attack']},
      {p: "discrider", a: ['move', 'tech', 'defend']},
      {p: "mono", a: ['move', 'tech', 'defend']},
      {p: "endless_serpents", a: ['defend', 'attack', 'tech']}
    ];

    // Derived - do not change
    let partyAtk = Math.floor(partyLvs.reduce((a,b) => a + b, 0)/4);
    let partyHP =  Math.floor(partyHps.reduce((a,b) => a + b, 0)/100);
    let partyMaxHP = Math.floor(partyMaxHps.reduce((a,b) => a + b, 0)/100);
    let enemyMaxHP = enemyHP;
    let partyMod = 0;
    let enemyMod = 0;
    let partyRoundOrder = [];
    let enemyRoundOrder = [];

    function shuffle(array) {
      var currentIndex = array.length,  randomIndex;
      while (0 !== currentIndex) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [
          array[randomIndex], array[currentIndex]];
      }
      return array;
    }

    function getRandomInt(max) {
      return Math.floor(Math.random() * max);
    }

    function dieRoll() {
      return getRandomInt(6);
    }

    function getSuccesses(d) {
      let successes = 0;
      const rolls = [];
      for (let i = 0; i < d; i++) {
        const roll = dieRoll();
        rolls.push(roll); 
        if (roll >= 4) {
          successes++;
        }
      }
      // console.log({successes, rolls});
      return successes;
    }

    function indTest(d1, ob) {
      return Math.max(0, getSuccesses(d1) - ob);
    }

    function vsTest() {
      const x = getSuccesses(partyAtk + partyMod) - getSuccesses(enemyAtk + enemyMod);
      partyMod = 0;
      enemyMod = 0;
      return x;
    }

    function enemyTest(o) {
      const x = indTest(enemyAtk + enemyMod, o);
      enemyMod = 0;
      return x;
    }

    function partyTest(o) {
      const x = indTest(partyAtk + partyMod, o);
      partyMod = 0;
      return x;
    }

    function logMessage(m, c) {
      let node = document.createElement("div");
      if (c) {
        node.setAttribute('class', c);
      }
      var textnode = document.createTextNode(m);
      node.appendChild(textnode);
      document.getElementById("log").appendChild(node);
    }

    function enemyHPChange(v) {
      if (v < 0) {
        enemyHP -= v;
        enemyHP = enemyHP <= enemyMaxHP ? enemyHP : enemyMaxHP;
        logMessage("The enemy recovered " + -v + " damage. HP increased to " + enemyHP + ".");
      }
      else if (v == 0) {
        logMessage("The enemy's HP remained the same.");
      }
      if (v > 0) {
        enemyHP = enemyHP >= 0 ? enemyHP : 0;
        enemyHP -= v;
        logMessage("The enemy took " + v + " damage. HP reduced to " + enemyHP + ".");
      }
      if (enemyHP <= 0) {
        enemyHP = 0;
        logMessage("The enemy was defeated!", "victory");
        logMessage(`Party HP: ${partyHP}/${partyMaxHP}`);
      }
    }

    function partyHPChange(v) {
      if (v < 0) {
        partyHP -= v;
        partyHP = partyHP <= partyMaxHP ? partyHP : partyMaxHP;
        logMessage("The party recovered " + -v + " damage. HP increased to " + partyHP + ".");
      }
      else if (v == 0) {
        logMessage("The party's HP remained the same.");
      }
      if (v > 0) {
        partyHP -= v;
        partyHP = partyHP >= 0 ? partyHP : 0;
        logMessage("The party took " + v + " damage. HP reduced to " + partyHP + ".");
      }
      if (partyHP <= 0) {
        logMessage("The party was defeated...", "defeat");
        logMessage(`Enemy HP: ${enemyHP}/${enemyMaxHP}`);
      }
    }

    function getPartyMember() {
      if (partyRoundOrder.length == 0) {
        partyRoundOrder = shuffle([...partyMembers]);
      }
      return partyRoundOrder.pop();
    }

    function getEnemy() {
      if (enemyRoundOrder.length == 0) {
        enemyRoundOrder = shuffle([...enemies]);
        console.log(enemyRoundOrder);
      }
      return enemyRoundOrder.pop();
    }

    function turnText(a, b) {
      logMessage(`${getPartyMember()} ${a} vs ${getEnemy()} ${b}`, 'turn');
    }

    function compareAttack(e) {
      turnText('attack', e);
      switch(e) {
        case "attack":
          enemyHPChange(partyTest(0));
          partyHPChange(enemyTest(0));
          break;
        case "defend":
          enemyHPChange(vsTest());
          break;
        case "tech":
          logMessage("Enemy tech interrupted!");
          enemyHPChange(vsTest());
          break;
        case "move":
          const v = vsTest();
          if (v >= 0) {
            enemyHPChange(v);
          }
          if (v == -1) {
            logMessage("Party disadvantaged!");
            partyMod = -1;
          }
          if (v < -1) {
            logMessage("Enemy gains advantage!");
            enemyMod = 2;
          }
          break;
      }
    }

    function compareDefend(e) {
      turnText('defend', e);
      switch(e) {
        case "attack":
          partyHPChange(vsTest());
          break;
        case "defend":
          partyHPChange(-partyTest(3));
          enemyHPChange(-enemyTest(3));
          break;
        case "tech":
          logMessage("Enemy tech cancelled player defense!");
          partyHPChange(enemyTest(0));
          break;
        case "move":
          const v = vsTest();
          if (v >= 0) {
            logMessage("Enemy failed to gain an advantage.")
            partyHPChange(-v);
          }
          if (v == -1) {
            logMessage("Party disadvantaged!");
            partyMod = -1;
          }
          if (v < -1) {
            logMessage("Enemy gains advantage!");
            enemyMod = 2;
          }
          break;
      }
    }

    function compareTech(e) {
      turnText('tech', e);
      let v = 0;
      switch(e) {
        case "attack":
          logMessage("Player tech interrupted!");
          v = vsTest();
          if (v > 0) {
            partyHPChange(v);
          }
          break;
        case "defend":
          logMessage("Party tech cancelled enemy defense!");
          enemyHPChange(partyTest(0));
          break;
        case "tech":
          v = vsTest();
          if (v > 0) {
            enemyHPChange(v);
          }
          else if (v < 0) {
            partyHPChange(-v);
          }
          else {
            logMessage("The techs cancelled each other out!");
          }
          break;
        case "move":
          v = partyTest(0);
          if (v > 0) {
            enemyHPChange(v);
          }
          v = enemyTest(0);
          if (v <= 0) {
            logMessage("Enemy failed to gain an advantage.")
          }
          if (v == 1) {
            logMessage("Party disadvantaged!");
            partyMod = -1;
          }
          if (v > 1) {
            logMessage("Enemy gains advantage!");
            enemyMod = 2;
          }
          break;
      }
    }

    function compareMove(e) {
      turnText('move', e);
      let v = 0;
      switch(e) {
        case "attack":
          v = vsTest();
          if (v <= 0) {
            logMessage("Party failed to gain an advantage.");
            partyHPChange(-v);
          }
          else if (v == 1) {
            logMessage("Enemy disadvantaged!");
            enemyMod = -1;
          }
          else if (v > 1) {
            logMessage("Party gains advantage!");
            partyMod + 2;
          }
          break;
        case "defend":
          v = vsTest();
          if (v <= 0) {
            logMessage("Party failed to gain an advantage.");
            enemyHPChange(-v);
          }
          else if (v == 1) {
            logMessage("Enemy disadvantaged!");
            enemyMod = -1;
          }
          else if (v > 1) {
            logMessage("Party gains advantage!");
            partyMod = 2;
          }
          break;
        case "tech":
          v = partyTest(0);
          if (v <= 0) {
            logMessage("Party failed to gain an advantage.");
            partyHPChange(enemyTest(0));
          }
          else if (v == 1) {
            logMessage("Enemy disadvantaged!");
            enemyMod = -1;
          }
          else if (v > 1) {
            logMessage("Party gains advantage!");
            partyMod = 2;
          }
          break;
        case "move":
          v = partyTest(0);
          const v2 = enemyTest(0);
          if (v <= 0) {
            logMessage("Party failed to gain an advantage.");
          }
          else if (v == 1) {
            logMessage("Enemy disadvantaged!");
            enemyMod = -1;
          }
          else if (v > 1) {
            logMessage("Party gains advantage!");
            partyMod + 2;
          }
          if (v2 <= 0) {
            logMessage("Enemy failed to gain an advantage.");
          }
          else if (v == 1) {
            logMessage("Party disadvantaged!");
            partyMod -= 1;
          }
          else if (v > 1) {
            logMessage("Enemy gains advantage!");
            enemyMod += 2;
          }
          break;
      }

    }

    function compare(p, e) {
      if (!combatContinue()) {
        return;
      }
      switch(p) {
        case "attack":
          compareAttack(e);
          break;
        case "defend":
          compareDefend(e);
          break;
        case "tech":
          compareTech(e);
          break;
        case "move":
          compareMove(e);
          break;
      }
    }

    function combatContinue() {
      return partyHP > 0 && enemyHP > 0;
    }

    logMessage("Party HP: " + partyHP + " / Atk: " + partyAtk);
    logMessage("Enemy HP: " + enemyHP + " / Atk: " + enemyAtk);
    
    enemyDeck = ["attack", "defend", "tech", "move"];

    while (partyHP > 0 && enemyHP > 0) {
      playerTurns = shuffle(playerTurns);
      // console.log(playerTurns);
      
      for(let i = 0; i < playerTurns.length; i++) {
        if (partyHP > 0 && enemyHP > 0) {
          logMessage("\n=== " + playerTurns[i].p + "'s round ===", "round");
          enemyTurn = shuffle(enemyDeck);
          for (let j = 0; j < 3; j++) {
            compare(playerTurns[i].a[j], enemyTurn[j]);
          }
        }
      }
    }
  </script>
</body>
</html>